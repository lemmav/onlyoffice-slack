<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, caller-scalable=no, minimal-ui" />
        <title>ONLYOFFICE</title>
        <link rel="icon" type="image/x-icon" href="/favicon.ico">

        <link rel="stylesheet" href="/styles/root.css">
        <link rel="stylesheet" href="/styles/loading.css">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>
        <link href='https://fonts.googleapis.com/css?family=Lato:700,400&display=swap' rel='stylesheet'>
    </head>
    <body class="loading-page">
        <div class="loading-container">
            <img src="/images/logo_long.svg" alt="ONLYOFFICE Logo" class="loading__logo">
            <div class="loading-container__spinner"></div>
            <div class="loading-container__title">[[${title}]]</div>
            <div class="loading-container__description">[[${description}]]</div>
            <div id="error-block" class="loading-container__error-block" style="display:none; flex-direction:column; align-items:center; justify-content:center;">
                <div id="error-message" class="loading-container__error-message" style="text-align:center; margin-bottom:16px;">
                    [[${error}]]
                </div>
                <button id="retry-button" class="loading-container__button" style="margin:0 auto;">[[${retry}]]</button>
            </div>
            <button id="cancel-button" class="loading-container__button" onclick="window.location.href='/'">[[${cancel}]]</button>
        </div>
        <script>
            var sessionId = "[[${sid}]]";
            let maxWaitTime, pollInterval, startTime;

            function showError() {
                document.querySelector('.loading-container__spinner').style.display = 'none';
                document.querySelector('.loading-container__title').style.display = 'none';
                document.querySelector('.loading-container__description').style.display = 'none';
                document.getElementById('error-block').style.display = 'flex';
                document.getElementById('cancel-button').style.display = 'none';
            }

            function checkSessionStatus() {
                const currentTime = Date.now();
                const elapsed = currentTime - startTime;

                if (elapsed >= maxWaitTime) {
                    showError();
                    return;
                }

                fetch(`/editor/status?session=${encodeURIComponent(sessionId)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.ready) {
                            window.location.href = `editor/content?session=${encodeURIComponent(sessionId)}`;
                        } else {
                            setTimeout(checkSessionStatus, pollInterval);
                        }
                    })
                    .catch(error => {
                        if (elapsed < maxWaitTime) {
                            setTimeout(checkSessionStatus, pollInterval);
                        } else {
                            showError();
                        }
                    });
            }

            function initializeEditor() {
                if (!sessionId || sessionId.indexOf('$') !== -1 || sessionId.indexOf('{') !== -1) {
                    showError();
                    return;
                }
                maxWaitTime = 5000;
                pollInterval = 500;
                startTime = Date.now();
                setTimeout(checkSessionStatus, 100);
            }

            document.getElementById('retry-button').onclick = function() {
                window.location.reload();
            };

            document.addEventListener('DOMContentLoaded', initializeEditor);
        </script>
    </body>
</html>